<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://accounts.google.com https://apis.google.com;
    style-src 'self' 'unsafe-inline';
    connect-src 'self' https://*.googleapis.com https://accounts.google.com https://api.open-meteo.com https://geocoding-api.open-meteo.com https://api.mymemory.translated.net https://api.rss2json.com https://api.openai.com;
    img-src 'self' data: https:;
    frame-src https://accounts.google.com;
  ">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AI Agent">
  <title>AI Agent</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="app">
    <!-- ヘッダー -->
    <header id="header">
      <h1>AI Agent</h1>
      <div id="status-bar">
        <span id="google-status" class="status-dot disconnected"></span>
        <span id="google-status-text">未接続</span>
      </div>
    </header>

    <!-- タブナビゲーション -->
    <nav id="tabs">
      <button class="tab active" data-tab="home">
        <span class="tab-icon">🎤</span>
        <span class="tab-label">エージェント</span>
      </button>
      <button class="tab" data-tab="history">
        <span class="tab-icon">📋</span>
        <span class="tab-label">履歴</span>
      </button>
      <button class="tab" data-tab="settings">
        <span class="tab-icon">⚙️</span>
        <span class="tab-label">設定</span>
      </button>
    </nav>

    <!-- ホーム画面 -->
    <main id="page-home" class="page active">
      <div class="home-content">
        <div id="agent-icon-area">
          <div id="agent-icon">🎤</div>
          <div id="pulse-ring"></div>
        </div>
        <p id="state-message">タップして開始</p>

        <!-- 波形 -->
        <canvas id="wave-canvas" width="320" height="60"></canvas>

        <!-- 認識テキスト -->
        <div id="transcription-area">
          <p id="transcription"></p>
        </div>

        <!-- プログレス表示 -->
        <div id="progress-area" class="hidden">
          <div id="progress-steps">
            <div class="progress-step" data-step="parse">
              <span class="step-icon">🔍</span>
              <span>解析</span>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="execute">
              <span class="step-icon">⚡</span>
              <span>実行</span>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="done">
              <span class="step-icon">✓</span>
              <span>完了</span>
            </div>
          </div>
        </div>

        <!-- レスポンス -->
        <div id="response-area" class="hidden">
          <p id="response-text"></p>
        </div>

        <!-- クイックアクション -->
        <div id="quick-actions">
          <button class="quick-btn" id="btn-reminder">
            <span class="icon">⏰</span>リマインダー
          </button>
          <button class="quick-btn" data-cmd="領収書">
            <span class="icon">🧾</span>領収書
          </button>
          <button class="quick-btn" data-cmd="タスク一覧">
            <span class="icon">✅</span>タスク
          </button>
        </div>

        <!-- コントロール -->
        <div id="controls">
          <button id="btn-keyboard" class="control-btn secondary" title="テキスト入力">⌨️</button>
          <button id="btn-mic" class="control-btn primary">
            <span id="mic-icon">🎙️</span>
          </button>
          <div class="control-btn placeholder"></div>
        </div>

        <!-- テキスト入力 -->
        <div id="manual-input" class="hidden">
          <input type="text" id="input-command" placeholder="コマンドを入力...">
          <button id="btn-send">送信</button>
        </div>

        <!-- カメラ入力（領収書用） -->
        <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
      </div>
    </main>

    <!-- 確認ダイアログ -->
    <div id="confirm-overlay" class="hidden">
      <div id="confirm-dialog">
        <h3 id="confirm-title">実行内容の確認</h3>
        <div id="confirm-body"></div>
        <div id="confirm-buttons">
          <button id="btn-confirm-cancel" class="confirm-btn cancel">キャンセル</button>
          <button id="btn-confirm-ok" class="confirm-btn ok">実行</button>
        </div>
      </div>
    </div>

    <!-- リマインダーダイアログ -->
    <div id="reminder-overlay" class="hidden">
      <div id="reminder-dialog">
        <h3>⏰ リマインダー作成</h3>

        <label class="reminder-label">内容</label>
        <div class="reminder-input-row">
          <input type="text" id="reminder-title" placeholder="何をリマインドしますか？">
          <button id="btn-reminder-voice" class="reminder-voice-btn">🎤</button>
        </div>
        <p id="reminder-voice-status" class="reminder-hint"></p>

        <label class="reminder-label">いつ？</label>
        <div class="reminder-time-presets">
          <button class="time-preset" data-minutes="10">10分後</button>
          <button class="time-preset" data-minutes="30">30分後</button>
          <button class="time-preset" data-minutes="60">1時間後</button>
          <button class="time-preset" data-minutes="180">3時間後</button>
          <button class="time-preset" data-minutes="tomorrow9">明日9時</button>
          <button class="time-preset" data-minutes="custom">カスタム</button>
        </div>

        <div id="reminder-custom-time" class="hidden">
          <input type="datetime-local" id="reminder-datetime">
        </div>

        <p id="reminder-selected-time" class="reminder-time-display"></p>

        <div class="reminder-buttons">
          <button id="btn-reminder-cancel" class="confirm-btn cancel">キャンセル</button>
          <button id="btn-reminder-create" class="confirm-btn ok">作成</button>
        </div>
      </div>
    </div>

    <!-- 履歴画面 -->
    <main id="page-history" class="page">
      <div class="page-header">
        <h2>コマンド履歴</h2>
      </div>
      <div id="history-list">
        <div class="empty-state">
          <p class="empty-icon">📋</p>
          <p>まだコマンド履歴がありません</p>
          <p class="empty-sub">音声またはテキストでコマンドを実行すると<br>ここに履歴が表示されます</p>
        </div>
      </div>
    </main>

    <!-- 設定画面 -->
    <main id="page-settings" class="page">
      <div class="page-header">
        <h2>設定</h2>
      </div>
      <div class="settings-content">
        <!-- Google アカウント -->
        <section class="settings-section">
          <h3>Google アカウント</h3>
          <label class="settings-label">クライアントID</label>
          <input type="text" id="input-client-id" placeholder="xxxxx.apps.googleusercontent.com" class="settings-input">
          <button id="btn-save-client-id" class="settings-btn">クライアントIDを保存</button>
          <div id="auth-status">
            <p id="auth-message">未ログイン</p>
          </div>
          <button id="btn-google-auth" class="settings-btn primary">Googleアカウントでログイン</button>
          <p class="settings-note">Googleカレンダー、Google Tasks、Google Driveへのアクセスに必要です</p>
        </section>

        <!-- 外部アプリ連携 -->
        <section class="settings-section">
          <h3>外部アプリ連携</h3>
          <label class="toggle-row">
            <span>リマインダーにDueアプリを使用</span>
            <input type="checkbox" id="toggle-due">
            <span class="toggle-slider"></span>
          </label>
          <p class="settings-note">ONにすると「リマインドして」でDueアプリが開きます（iOSのみ）</p>

          <label class="settings-label" style="margin-top: 16px;">領収書保存先 (Google Drive フォルダID)</label>
          <input type="text" id="input-drive-folder" placeholder="フォルダIDを入力" class="settings-input">
          <button id="btn-save-drive-folder" class="settings-btn">保存</button>
          <p class="settings-note">「領収書登録」でカメラ撮影→自動アップロードされます</p>
        </section>

        <!-- OpenAI API -->
        <section class="settings-section">
          <h3>OpenAI API キー（オプション）</h3>
          <div class="input-group">
            <input type="password" id="input-openai-key" placeholder="sk-..." class="settings-input">
            <button id="btn-toggle-key" class="icon-btn">👁️</button>
          </div>
          <button id="btn-save-key" class="settings-btn">保存</button>
          <p class="settings-note">設定すると高度な自然言語理解が利用できます。未設定でもルールベースで動作します。</p>
        </section>

        <!-- 対応コマンド -->
        <section class="settings-section">
          <h3>対応コマンド</h3>
          <table class="command-table">
            <tr><td class="cmd-type">予定作成</td><td>「明日の10時に会議を入れて」</td></tr>
            <tr><td class="cmd-type">予定確認</td><td>「今日の予定を教えて」</td></tr>
            <tr><td class="cmd-type">タスク作成</td><td>「〜をタスクに追加」</td></tr>
            <tr><td class="cmd-type">タスク一覧</td><td>「タスクを確認して」</td></tr>
            <tr><td class="cmd-type">リマインダー</td><td>「〜をリマインドして」※Due必須</td></tr>
            <tr><td class="cmd-type">領収書登録</td><td>「領収書」「レシート」</td></tr>
            <tr><td class="cmd-type">翻訳</td><td>「〜を英語に翻訳」</td></tr>
            <tr><td class="cmd-type">タイマー</td><td>「3分タイマー」</td></tr>
            <tr><td class="cmd-type">メモ</td><td>「〜をメモ」「メモ一覧」</td></tr>
          </table>
        </section>
      </div>
    </main>
  </div>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script type="module" src="js/app.js"></script>
</body>
</html>
